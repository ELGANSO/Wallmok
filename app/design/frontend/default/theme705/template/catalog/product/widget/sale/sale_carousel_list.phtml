<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magento.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magento.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2006-2014 X.commerce, Inc. (http://www.magento.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

$modules = Mage::getConfig()->getNode('modules')->children();
$modulesArray = (array)$modules;
if(isset($modulesArray['Tm_ProductListGallery'])) {
    $productgallerylist_helper = Mage::helper('productlistgallery');
    $productgallerylist_config = $productgallerylist_helper->getConfigData('home_grid');    
}


    $_productCollection=$this->getLoadedProductCollection();
    $_helper = $this->helper('catalog/output');
?>

<?php if (($_products = $this->getProductCollection()) && $_products->getSize()): ?>
	<div class="widget widget-catalogsale-products">
		<div class="page-title category-title">
			<h1><?php echo $this->__('Special products') ?></h1>
		</div>
		<?php $suffix = $this->getNameInLayout(); ?>
			<div class="products-grid owl-carousel" id="sale-carousel">
			<?php foreach ($_products->getItems() as $_product): ?>
				<div class="item" itemscope itemtype="http://schema.org/product">

					<div class="product_wrapper">
						<div class="product_top_container">
							<div class="product-image-container">
								<?php if ($productgallerylist_config['active'] == '1'): ?> 
                							                          <a href="<?php echo $_product->getProductUrl() ?>" title="<?php echo $this->stripTags($_product->getName(), null, true) ?>" class="product-image">
                							                            <img src="<?php echo $this->helper('catalog/image')->init($_product, 'small_image')->resize($productgallerylist_config['image_width']) ?>" width="<?php echo $productgallerylist_config['image_width']; ?>" alt="<?php echo $this->stripTags($_product->getName(), null, true) ?>" /></a>
                							                         
                							                         <ul class="product-thumbs">
                							                             <?php 
                							                             $product_id = $_product->getId();               
                							                             $list_product = Mage::getModel('catalog/product')->load($product_id);
                							                             $k = 0;
                							                                foreach ($list_product->getMediaGalleryImages() as $image) { if ($k<3):  ?>
                							                                 <li class="product-thumb">
                							                                    <a href="<?php echo $this->helper('catalog/image')->init($this->getProduct(), 'small_image', $image->getFile())->resize($productgallerylist_config['image_width']); ?>">
                							                                        <img src="<?php echo $this->helper('catalog/image')->init($this->getProduct(), 'thumbnail', $image->getFile())->resize($productgallerylist_config['small_image']); ?>" alt="" width="<?php echo $productgallerylist_config['thumb_size']; ?>"/>
                							                                    </a>
                							                                </li>
                							                             <?php endif; ?>
                							                                <?php $k++; ?>  
                							                             <?php } ?>
                							                         </ul>
                							                     <?php endif; ?>
                							     </div>                						<div class="name-block">
							<?php echo $this->getPriceHtml($_product, true) ?>
							<h2 class="product-name"><a href="<?php echo $_product->getProductUrl() ?>" title="<?php echo $this->stripTags($_product->getName(), null, true) ?>" itemprop="name"><?php echo $_helper->productAttribute($_product, $_product->getName(), 'name') ?></a></h2>
						</div>

						</div>

						<div class="product_bottom_container">
							<div class="product-shop">
								<?php echo $this->getReviewsSummaryHtml($_product, 'short') ?>
								<div class="actions">
									<?php if($_product->isSaleable()): ?>
										<button type="button" title="<?php echo $this->__('Add to Cart') ?>" class="button btn-cart" onclick="setLocation('<?php echo $this->getAddToCartUrl($_product) ?>')"><span><i class="flaticon-shopping231"></i><span><?php echo $this->__('Add to Cart') ?></span></span></button>
									<?php else: ?>
										<p class="availability out-of-stock"><span><?php echo $this->__('Out of stock') ?></span></p>
									<?php endif; ?>
									<ul class="add-to-links">
										<?php if ($this->helper('wishlist')->isAllow()) : ?>
											<li><a title="" href="<?php echo $this->helper('wishlist')->getAddUrl($_product) ?>" rel="tooltip" class="link-wishlist"><i class="flaticon-favorite22"></i><span><?php echo $this->__('Add to Wishlist') ?></span></a></li>
										<?php endif; ?>
										<?php if($_compareUrl=$this->getAddToCompareUrl($_product)): ?>
											<li><a  title="" href="<?php echo $_compareUrl ?>" rel="tooltip" class="link-compare "><i class="flaticon-shuffle24"></i><span><?php echo $this->__('Add to Compare') ?></span></a></li>
										<?php endif; ?>
									</ul>
								</div>
							</div>
						</div>
						<?php $_product = Mage::getModel('catalog/product')->load($_product->getId()); ?>
						<div class="label-product">             
							<?php if($_product->getData('new')){echo '<span class="new">'.$this->__('New').'</span>';  }?>
							<?php if($_product->getData('sale')){echo '<span class="sale">'.$this->__('Sale').'</span>';  }?>
						</div>
					</div>
				</div>
			<?php endforeach; ?>
			</div>

			<script type="text/javascript">decorateList('widget-catalogsale-products-<?php echo $suffix; ?>', 'none-recursive')</script>
	</div>

<script>
	jQuery(document).ready(function() {
		jQuery("#sale-carousel").owlCarousel({
			navigation: true,
			pagination: false,
			singleItem:false,
			navigationText: false,
			items:4,
			itemsDesktop : [991,3], 
			itemsDesktopSmall : [767,2],
			itemsTablet: [500,1],
			itemsMobile : false 
		});
	});
</script>
<?php endif; ?>
